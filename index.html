<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monthly Payments</title>

  <style>
    html {
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 20px; /* slightly smaller for a cleaner UI */
    }

    body {
      margin: 0;
      background: #000;
      color: #f5f5f5;
    }

    .app {
      padding: 22px 10px 80px;
    }

    h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #b0b0b8;
      margin-bottom: 22px;
    }

    h2 {
      font-size: 22px;
      font-weight: 700;
      margin: 18px 4px 8px;
    }

    .section {
      margin-bottom: 18px;
    }

    .bill {
      background: #1c1c1e;
      padding: 18px 22px;
      border-bottom: 1px solid #2c2c2e;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .bill:active {
      opacity: 0.85;
    }

    .bill-paid {
      background: #234223;
      text-decoration: line-through;
      opacity: 0.8;
      cursor: default;
    }

    .bill-name {
      font-size: 25px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .auto-pay {
      font-size: 18px;
      opacity: 0.75;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 700;
    }

    .badge-overdue {
      background: #ff3b30;
      color: #fff;
    }

    .badge-today {
      background: #ff9f0a;
      color: #000;
    }

    .meta {
      color: #b0b0b8;
      font-size: 16px;
      line-height: 1.2;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }

    /* Collapsible paid section */
    .collapsible-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 18px 4px 8px;
      cursor: pointer;
      user-select: none;
    }

    .chevron {
      width: 24px;
      text-align: center;
      font-weight: 900;
    }

    .paid-container.is-collapsed {
      display: none;
    }

    /* Inline pay UI (appears under clicked bill) */
    .pay-inline {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: default;
    }

    .pay-inline input {
      width: 100%;
      box-sizing: border-box;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: #2c2c2e;
      color: #fff;
      font-size: 20px;
    }

    .pay-inline button {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 20px;
      font-weight: 800;
      background: #ff9f0a;
      cursor: pointer;
    }

    .pay-inline button:disabled {
      background: #3a3a3c;
      color: #aaa;
    }
  </style>
</head>

<body>
  <div class="app">
    <h1>Monthly Payments</h1>
    <div class="subtitle">Tap a bill to log a payment.</div>

    <div class="section">
      <h2>Pay immediately</h2>
      <div id="payImmediately"></div>
    </div>

    <div class="section">
      <h2>Upcoming (next 5 days)</h2>
      <div id="upcoming"></div>
    </div>

    <div class="section">
      <div
        class="collapsible-header"
        id="paidHeader"
        role="button"
        tabindex="0"
        aria-expanded="false"
      >
        <span class="chevron" id="paidChevron">▸</span>
        <div style="display:flex; align-items:baseline; gap:10px;">
          <h2 style="margin:0;">Already paid</h2>
          <span class="subtitle" id="paidCount" style="margin:0; font-size:16px;"></span>
        </div>
      </div>

      <div id="paid" class="paid-container is-collapsed"></div>
    </div>
  </div>

  <script>
    let paidOpen = false;          // paid section collapsed by default
    let expandedBillId = null;     // inline payment expanded bill

    async function fetchStatus() {
      const res = await fetch("/api/GetStatus");
      if (!res.ok) throw new Error("Failed to load status");
      return res.json();
    }

    async function logPayment(billId, amount) {
      const res = await fetch("/api/LogPayment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ billId, amount })
      });
      if (!res.ok) throw new Error("Failed to save payment");
    }

    function renderList(containerId, list, paid = false) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      if (!list.length) {
        container.textContent = "Nothing here.";
        return;
      }

      list.forEach(bill => {
        const div = document.createElement("div");
        div.className = "bill" + (paid ? " bill-paid" : "");

        const name = document.createElement("div");
        name.className = "bill-name";

        const title = document.createElement("span");
        title.textContent = bill.name;
        name.appendChild(title);

        if (bill.autoPay === true) {
          const auto = document.createElement("span");
          auto.className = "auto-pay";
          auto.title = "Automatic payment enabled";
          auto.textContent = "⚙️";
          name.appendChild(auto);
        }

        if (!paid && bill.daysOverdue !== undefined) {
          const badge = document.createElement("span");
          badge.className = "badge " + (bill.daysOverdue > 0 ? "badge-overdue" : "badge-today");
          badge.textContent = bill.daysOverdue > 0 ? `${bill.daysOverdue}d overdue` : "Due today";
          name.appendChild(badge);
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `
          <span>Last: ${Number(bill.lastAmount || 0).toFixed(2)}</span>
          <span>Due: ${bill.dueDate || ""}</span>
        `;

        div.append(name, meta);

        // Paid items don't expand
        if (paid) {
          container.appendChild(div);
          return;
        }

        // Inline pay UI (only for expanded bill)
        const isExpanded = expandedBillId === bill.id;
        if (isExpanded) {
          const inline = document.createElement("div");
          inline.className = "pay-inline";

          const input = document.createElement("input");
          input.type = "number";
          input.inputMode = "decimal";
          input.placeholder = bill.lastAmount ? String(bill.lastAmount) : "Amount";
          input.value = bill.lastAmount ? String(bill.lastAmount) : "";

          const btn = document.createElement("button");
          btn.textContent = "Pay";

          // Prevent collapsing when interacting with input
          input.onclick = (e) => e.stopPropagation();

          btn.onclick = async (e) => {
            e.stopPropagation(); // don't collapse on pay click
            btn.disabled = true;

            const amount = Number(input.value);
            if (!Number.isFinite(amount) || amount <= 0) {
              btn.disabled = false;
              alert("Enter a valid amount greater than 0.");
              return;
            }

            try {
              await logPayment(bill.id, amount);
              expandedBillId = null; // collapse after paying
              load();
            } catch (err) {
              btn.disabled = false;
              alert("Failed to save payment.");
            }
          };

          inline.append(input, btn);
          div.appendChild(inline);

          setTimeout(() => input.focus(), 0);
        }

        // Toggle expand/collapse on card click
        div.onclick = () => {
          expandedBillId = (expandedBillId === bill.id) ? null : bill.id;
          load();
        };

        container.appendChild(div);
      });
    }

    function updatePaidUI() {
      const paidEl = document.getElementById("paid");
      const chevron = document.getElementById("paidChevron");
      const header = document.getElementById("paidHeader");

      paidEl.classList.toggle("is-collapsed", !paidOpen);
      chevron.textContent = paidOpen ? "▾" : "▸";
      header.setAttribute("aria-expanded", String(paidOpen));
    }

    function setupPaidToggle() {
      const header = document.getElementById("paidHeader");

      header.onclick = () => {
        paidOpen = !paidOpen;
        updatePaidUI();
      };

      header.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          paidOpen = !paidOpen;
          updatePaidUI();
        }
      };

      updatePaidUI();
    }

    async function load() {
      const data = await fetchStatus();

      // Sort pay immediately by most overdue first
      const payNowSorted = [...(data.payImmediately || [])].sort(
        (a, b) => (b.daysOverdue ?? 0) - (a.daysOverdue ?? 0)
      );

      renderList("payImmediately", payNowSorted);
      renderList("upcoming", data.upcoming || []);
      renderList("paid", data.paid || [], true);

      document.getElementById("paidCount").textContent = `(${(data.paid || []).length})`;
      setupPaidToggle();
    }

    load();
  </script>
</body>
</html>