<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monthly Payments</title>

  <style>
    html {
      font-family: system-ui, -apple-system, sans-serif;
      font-size: 20px;
    }

    body {
      margin: 0;
      background: #000;
      color: #f5f5f5;
    }

    .app {
      padding: 22px 10px 120px;
    }

    h1 {
      font-size: 32px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .subtitle {
      color: #b0b0b8;
      margin-bottom: 18px;
    }

    h2 {
      font-size: 22px;
      font-weight: 700;
      margin: 18px 4px 8px;
    }

    .section {
      margin-bottom: 18px;
    }

    .bill {
      background: #1c1c1e;
      padding: 18px 22px;
      border-bottom: 1px solid #2c2c2e;
      display: flex;
      flex-direction: column;
      gap: 8px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }

    .bill:active {
      opacity: 0.85;
    }

    .bill-paid {
      background: #234223;
      opacity: 0.8;
      cursor: default;
      /* No line-through styling */
    }

    .bill-name {
      font-size: 25px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .auto-pay {
      font-size: 18px;
      opacity: 0.75;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 14px;
      font-weight: 700;
    }

    .badge-overdue {
      background: #ff3b30;
      color: #fff;
    }

    .badge-today {
      background: #ff9f0a;
      color: #000;
    }

    .meta {
      color: #b0b0b8;
      font-size: 16px;
      line-height: 1.2;
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }

    .collapsible-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 18px 4px 8px;
      cursor: pointer;
      user-select: none;
    }

    .chevron {
      width: 24px;
      text-align: center;
      font-weight: 900;
    }

    .paid-container.is-collapsed {
      display: none;
    }

    .pay-inline {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      cursor: default;
    }

    .pay-inline input {
      width: 100%;
      box-sizing: border-box;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: #2c2c2e;
      color: #fff;
      font-size: 20px;
    }

    .pay-inline button {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 20px;
      font-weight: 800;
      background: #ff9f0a;
      cursor: pointer;
    }

    .pay-inline button:disabled {
      background: #3a3a3c;
      color: #aaa;
    }

    .bottom-glass {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      padding: 14px 12px calc(14px + env(safe-area-inset-bottom));
      background: rgba(28, 28, 30, 0.45);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
      backdrop-filter: blur(18px) saturate(140%);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .bottom-glass .pill {
      background: rgba(44, 44, 46, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.10);
      border-radius: 18px;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    .bottom-glass .right {
      color: rgba(176, 176, 184, 0.9);
      font-size: 14px;
      white-space: nowrap;
      cursor: pointer;
    }

    .auth-link {
      color: rgba(176, 176, 184, 0.9);
      font-size: 14px;
      font-weight: 700;
      text-decoration: none;
    }

    /* === Dock (consistent nav) === */
    .bottom-glass .dock {
      background: rgba(44, 44, 46, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.10);
      border-radius: 18px;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    .dock-left { display: flex; flex-direction: column; gap: 2px; }
    .dock-title { font-size: 16px; font-weight: 800; margin: 0; color: rgba(245, 245, 245, 0.95); }
    .dock-sub { font-size: 13px; margin: 0; color: rgba(176, 176, 184, 0.9); }

    .dock-actions { display: flex; gap: 10px; align-items: center; }

    .dock-btn {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(44, 44, 46, 0.35);
      color: #f5f5f5;
      font-size: 14px;
      font-weight: 800;
      cursor: pointer;
      user-select: none;
    }
    .dock-btn:active { transform: scale(0.98); }

    .menu-wrap { position: relative; }
    .menu-pop {
      position: absolute;
      right: 0;
      bottom: 48px;
      min-width: 160px;
      background: rgba(28, 28, 30, 0.96);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      box-shadow: 0 14px 45px rgba(0,0,0,0.55);
      padding: 8px;
      display: none;
    }
    .menu-pop.open { display: block; }
    .menu-item {
      display: block;
      padding: 10px 10px;
      border-radius: 10px;
      color: rgba(245,245,245,0.95);
      text-decoration: none;
      font-size: 14px;
      font-weight: 800;
    }
    .menu-item:active { opacity: 0.75; }
  </style>
</head>

<body>
  <div class="app">
    <h1>This Month</h1>

    <div class="section">
      <h2>Pay immediately</h2>
      <div id="payImmediately"></div>
    </div>

    <div class="section">
      <h2>Upcoming (next 5 days)</h2>
      <div id="upcoming"></div>
    </div>

    <div class="section">
      <div class="collapsible-header" id="paidHeader" role="button" tabindex="0" aria-expanded="false">
        <span class="chevron" id="paidChevron">▸</span>
        <div style="display:flex; align-items:baseline; gap:10px;">
          <h2 style="margin:0;">Already paid</h2>
          <span class="subtitle" id="paidCount" style="margin:0; font-size:16px;"></span>
        </div>
      </div>
      <div id="paid" class="paid-container is-collapsed"></div>
    </div>
  </div>

  <div class="bottom-glass">
    <div class="dock">
      <div class="dock-left">
        <p class="dock-title">This Month</p>
        <p class="dock-sub" id="dockSub">Loading…</p>
      </div>

      <div class="dock-actions">
        <div class="dock-btn" onclick="goToHistory()">History →</div>
        <div class="dock-btn" onclick="goToExpenses()">Expenses →</div>

        <div class="menu-wrap">
          <div class="dock-btn" id="menuBtn" aria-label="Menu" role="button" tabindex="0">⋯</div>
          <div class="menu-pop" id="menuPop">
            <a class="menu-item" href="/.auth/logout">Sign out</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let paidOpen = false;
    let expandedBillId = null;

    // COP currency formatting (no decimals)
    const copFmt = new Intl.NumberFormat("es-CO", {
      style: "currency",
      currency: "COP",
      maximumFractionDigits: 0,
      minimumFractionDigits: 0
    });

    function formatPaidAt(iso) {
      if (!iso) return "";
      return new Date(iso).toLocaleDateString("en-US", {
        month: "short",
        day: "numeric"
      });
    }

    // Digits-only currency input (no '.' allowed). User types digits, we format COP while typing.
    // Stores the raw digits (integer pesos) in input.dataset.amount
    function attachCopMoneyMask(inputEl, initialAmount = 0) {
      inputEl.type = "text";
      inputEl.inputMode = "numeric";
      inputEl.autocomplete = "off";
      inputEl.spellcheck = false;

      inputEl.dataset.amount = String(Number(initialAmount || 0));

      const render = () => {
        const amount = Number(inputEl.dataset.amount || 0);
        inputEl.value = copFmt.format(amount);
        // keep caret at end (simple + predictable)
        const end = inputEl.value.length;
        inputEl.setSelectionRange(end, end);
      };

      render();

      inputEl.addEventListener("input", () => {
        // keep only digits
        const digits = String(inputEl.value || "").replace(/\D/g, "");
        inputEl.dataset.amount = digits ? String(parseInt(digits, 10)) : "0";
        render();
      });

      // Extra safety: sanitize paste (still works if browser triggers input anyway)
      inputEl.addEventListener("paste", (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData("text") || "";
        const digits = text.replace(/\D/g, "");
        inputEl.dataset.amount = digits ? String(parseInt(digits, 10)) : "0";
        render();
      });
    }

    async function fetchStatus() {
      const res = await fetch("/api/GetStatus", { cache: "no-store" });
      if (!res.ok) throw new Error("Failed to load status");
      return res.json();
    }

    async function logPayment(billId, amount) {
      const res = await fetch("/api/LogPayment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ billId, amount })
      });
      if (!res.ok) throw new Error("Failed to save payment");
    }

    function renderList(containerId, list, paid = false) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      if (!list.length) {
        container.textContent = "Nothing here.";
        return;
      }

      list.forEach(bill => {
        const div = document.createElement("div");
        div.className = "bill" + (paid ? " bill-paid" : "");

        const name = document.createElement("div");
        name.className = "bill-name";
        name.textContent = bill.name;

        if (bill.autoPay) {
          const auto = document.createElement("span");
          auto.className = "auto-pay";
          auto.textContent = "⚙️";
          name.appendChild(auto);
        }

        if (!paid && bill.daysOverdue !== undefined) {
          const badge = document.createElement("span");
          badge.className = "badge " + (bill.daysOverdue > 0 ? "badge-overdue" : "badge-today");
          badge.textContent = bill.daysOverdue > 0 ? `${bill.daysOverdue}d overdue` : "Due today";
          name.appendChild(badge);
        }

        const meta = document.createElement("div");
        meta.className = "meta";

        if (paid) {
          meta.innerHTML = `
            <span>Paid: ${formatPaidAt(bill.paidAt)}</span>
            <span>Amount: ${copFmt.format(Number(bill.paidAmount || 0))}</span>
          `;
        } else {
          meta.innerHTML = `
            <span>Last: ${copFmt.format(Number(bill.lastAmount || 0))}</span>
            <span>Due: ${bill.dueDate || ""}</span>
          `;
        }

        div.append(name, meta);

        if (paid) {
          container.appendChild(div);
          return;
        }

        if (expandedBillId === bill.id) {
          const inline = document.createElement("div");
          inline.className = "pay-inline";

          // Prevent collapsing when interacting with inline controls
          inline.onclick = (e) => e.stopPropagation();
          inline.onpointerdown = (e) => e.stopPropagation();

          const input = document.createElement("input");

          // Initialize with lastAmount (assumed pesos), show as COP currency while typing.
          attachCopMoneyMask(input, Number(bill.lastAmount || 0));

          // Prevent collapsing when interacting with input
          input.onclick = (e) => e.stopPropagation();
          input.onpointerdown = (e) => e.stopPropagation();
          input.onmousedown = (e) => e.stopPropagation();

          const btn = document.createElement("button");
          btn.textContent = "Pay";

          btn.onclick = async (e) => {
            e.stopPropagation();
            const amount = Number(input.dataset.amount || 0); // integer pesos, no decimals
            if (!amount) return;
            btn.disabled = true;
            await logPayment(bill.id, amount);
            expandedBillId = null;
            load();
          };

          inline.append(input, btn);
          div.appendChild(inline);
        }

        div.onclick = () => {
          expandedBillId = expandedBillId === bill.id ? null : bill.id;
          load();
        };

        container.appendChild(div);
      });
    }

    function updatePaidUI() {
      const paidEl = document.getElementById("paid");
      const chevron = document.getElementById("paidChevron");
      const header = document.getElementById("paidHeader");

      paidEl.classList.toggle("is-collapsed", !paidOpen);
      chevron.textContent = paidOpen ? "▾" : "▸";
      header.setAttribute("aria-expanded", String(paidOpen));
    }

    function setupPaidToggle() {
      const header = document.getElementById("paidHeader");
      header.onclick = () => {
        paidOpen = !paidOpen;
        updatePaidUI();
      };
      updatePaidUI();
    }

    async function load() {
      const data = await fetchStatus();

      const payNowSorted = [...(data.payImmediately || [])].sort(
        (a, b) => (b.daysOverdue ?? 0) - (a.daysOverdue ?? 0)
      );

      renderList("payImmediately", payNowSorted);
      renderList("upcoming", data.upcoming || []);
      renderList("paid", data.paid || [], true);

      document.getElementById("paidCount").textContent =
        `(${(data.paid || []).length})`;

      setupPaidToggle();

      // Dock subtitle counter
      const dueN = payNowSorted.length;
      const upN = (data.upcoming || []).length;
      const paidN = (data.paid || []).length;
      const dockSub = document.getElementById("dockSub");
      if (dockSub) dockSub.textContent = `${dueN} due • ${upN} upcoming • ${paidN} paid`;
    }

    function goToExpenses() {
      window.location.href = "/expenses.html";
    }

    function goToHistory() {
      window.location.href = "/payments-history.html";
    }

    // Bottom-menu (⋯)
    (function setupMenu(){
      const btn = document.getElementById("menuBtn");
      const pop = document.getElementById("menuPop");
      if (!btn || !pop) return;

      function close() { pop.classList.remove("open"); }
      function toggle() { pop.classList.toggle("open"); }

      btn.onclick = (e) => { e.stopPropagation(); toggle(); };
      btn.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
        if (e.key === "Escape") close();
      };

      document.addEventListener("click", (e) => {
        if (!pop.classList.contains("open")) return;
        if (pop.contains(e.target) || btn.contains(e.target)) return;
        close();
      });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") close(); });
    })();

    load();
  </script>
</body>
</html>