<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Log Payment</title>

  <style>
    html { font-family: system-ui, -apple-system, sans-serif; font-size: 22px; }
    body { margin: 0; background: #000; color: #f5f5f5; }
    .app { padding: 26px 10px 80px; }
    h1 { font-size: 30px; font-weight: 800; margin: 0 0 14px; }
    .subtitle { color: #b0b0b8; margin: 0 0 18px; }

    .card {
      background: #1c1c1e;
      border: 2px solid #2c2c2e;
      border-radius: 16px;
      padding: 20px;
    }

    input {
      width: 100%;
      box-sizing: border-box;
      padding: 16px;
      border-radius: 14px;
      border: none;
      background: #2c2c2e;
      color: #fff;
      font-size: 24px;
      margin-top: 14px;
    }

    button {
      width: 100%;
      padding: 18px;
      border-radius: 14px;
      border: none;
      font-size: 26px;
      font-weight: 800;
      background: #ff9f0a;
      cursor: pointer;
      margin-top: 14px;
    }

    button:disabled { background: #3a3a3c; color: #aaa; }

    .secondary {
      background: transparent;
      border: 2px solid #2c2c2e;
      color: #f5f5f5;
      font-weight: 700;
    }

    .error {
      margin-top: 14px;
      color: #ff453a;
      font-size: 18px;
    }
  </style>
</head>

<body>
  <div class="app">
    <h1 id="title">Log Payment</h1>
    <p class="subtitle">Enter the amount and tap Save.</p>

    <div class="card">
      <div style="color:#b0b0b8; font-size:18px;">Bill</div>
      <div id="billName" style="font-size:28px; font-weight:800; margin-top:6px;"></div>

      <input id="amount" type="number" inputmode="decimal" placeholder="Amount" />

      <button id="saveBtn">Save</button>
      <button id="backBtn" class="secondary" type="button">Back</button>

      <div id="error" class="error" style="display:none;"></div>
    </div>
  </div>

  <script>
    function qs(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    async function logPayment(billId, amount) {
      const res = await fetch("/api/LogPayment", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ billId, amount })
      });
      if (!res.ok) throw new Error("Failed to save payment");
    }

    const billId = qs("billId");
    const name = qs("name") || "";
    const lastAmount = Number(qs("lastAmount") || 0);

    const billNameEl = document.getElementById("billName");
    const amountEl = document.getElementById("amount");
    const saveBtn = document.getElementById("saveBtn");
    const backBtn = document.getElementById("backBtn");
    const errorEl = document.getElementById("error");

    billNameEl.textContent = name || billId || "Unknown";
    amountEl.value = lastAmount ? String(lastAmount) : "";
    amountEl.placeholder = lastAmount ? String(lastAmount) : "Amount";
    amountEl.focus();

    backBtn.onclick = () => { window.location.href = "/"; };

    saveBtn.onclick = async () => {
      errorEl.style.display = "none";

      const amount = Number(amountEl.value);
      if (!billId) {
        errorEl.textContent = "Missing billId.";
        errorEl.style.display = "block";
        return;
      }
      if (!Number.isFinite(amount) || amount <= 0) {
        errorEl.textContent = "Enter a valid amount greater than 0.";
        errorEl.style.display = "block";
        return;
      }

      try {
        saveBtn.disabled = true;
        await logPayment(billId, amount);
        window.location.href = "/"; // back to the main list
      } catch (e) {
        saveBtn.disabled = false;
        errorEl.textContent = e?.message || "Failed to save.";
        errorEl.style.display = "block";
      }
    };
  </script>
</body>
</html>
