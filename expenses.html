<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Expenses</title>

  <style>
    html { font-family: system-ui, -apple-system, sans-serif; font-size: 20px; }
    body { margin: 0; background: #000; color: #f5f5f5; }

    .app { padding: 22px 10px 130px; } /* space for frosted bar */

    h1 { font-size: 32px; font-weight: 800; margin: 0 0 6px; }
    .subtitle { color: #b0b0b8; margin: 0 0 18px; font-size: 16px; }
    .section-title { font-size: 22px; font-weight: 700; margin: 18px 4px 10px; }

    /* List rows */
    .row {
      background: #1c1c1e;
      padding: 16px 20px;
      border-bottom: 1px solid #2c2c2e;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      -webkit-tap-highlight-color: transparent;
    }
    .row:active { opacity: 0.88; }
    .row.editing {
      outline: 2px solid rgba(255, 159, 10, 0.35);
      outline-offset: -2px;
    }

    .row-top {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
    }

    .name { font-size: 22px; font-weight: 700; line-height: 1.2; }
    .type {
      color: #b0b0b8;
      font-size: 14px;
      padding: 3px 8px;
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 999px;
      background: rgba(44,44,46,0.35);
      white-space: nowrap;
    }

    .meta {
      color: #b0b0b8;
      font-size: 15px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      line-height: 1.2;
    }

    /* Inline create/edit form */
    .form-card {
      background: rgba(28, 28, 30, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.10);
      border-radius: 18px;
      padding: 14px;
      margin: 12px 0 0;
      cursor: default;
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    label {
      font-size: 14px;
      color: #b0b0b8;
      display: block;
      margin: 0 0 6px;
    }

    input, select {
      width: 100%;
      box-sizing: border-box;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: #2c2c2e;
      color: #fff;
      font-size: 18px;
      outline: none;
    }

    .checks {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
      margin-top: 4px;
    }
    .check {
      display: flex;
      gap: 10px;
      align-items: center;
      margin: 0;
      user-select: none;
    }
    .check input {
      width: auto;
      transform: scale(1.2);
    }
    .check span {
      color: #b0b0b8;
      font-size: 16px;
    }

    .row-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }

    button {
      padding: 14px;
      border-radius: 14px;
      border: none;
      font-size: 18px;
      font-weight: 800;
      background: #ff9f0a;
      cursor: pointer;
    }

    button.secondary {
      background: transparent;
      border: 1px solid #2c2c2e;
      color: #f5f5f5;
      font-weight: 700;
    }

    button:disabled { background: #3a3a3c; color: #aaa; cursor: default; }

    .error {
      color: #ff453a;
      font-size: 14px;
      margin-top: 8px;
      display: none;
    }

    /* Frosted glass bottom bar */
    .bottom-glass {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 50;
      padding: 14px 12px calc(14px + env(safe-area-inset-bottom));
      background: rgba(28, 28, 30, 0.45);
      -webkit-backdrop-filter: blur(18px) saturate(140%);
      backdrop-filter: blur(18px) saturate(140%);
      border-top: 1px solid rgba(255, 255, 255, 0.08);
    }

    .bottom-glass .dock {
      background: rgba(44, 44, 46, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.10);
      border-radius: 18px;
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
    }

    .dock-left { display: flex; flex-direction: column; gap: 2px; }
    .dock-title { font-size: 16px; font-weight: 800; margin: 0; color: rgba(245, 245, 245, 0.95); }
    .dock-sub { font-size: 13px; margin: 0; color: rgba(176, 176, 184, 0.9); }

    .dock-actions { display: flex; gap: 10px; align-items: center; }
    .dock-btn {
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(44, 44, 46, 0.35);
      color: #f5f5f5;
      font-size: 14px;
      font-weight: 800;
      cursor: pointer;
      user-select: none;
    }
    .dock-btn.primary {
      background: rgba(255, 159, 10, 0.95);
      border: none;
      color: #000;
    }
    .dock-btn:active { transform: scale(0.98); }

    .dock-left-row { display: flex; align-items: center; gap: 10px; }
    .dock-btn.ghost {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.12);
      color: rgba(245, 245, 245, 0.95);
    }

    .menu-wrap { position: relative; }
    .menu-pop {
      position: absolute;
      right: 0;
      bottom: 48px;
      min-width: 160px;
      background: rgba(28, 28, 30, 0.96);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      box-shadow: 0 14px 45px rgba(0,0,0,0.55);
      padding: 8px;
      display: none;
    }
    .menu-pop.open { display: block; }
    .menu-item {
      display: block;
      padding: 10px 10px;
      border-radius: 10px;
      color: rgba(245,245,245,0.95);
      text-decoration: none;
      font-size: 14px;
      font-weight: 800;
    }
    .menu-item:active { opacity: 0.75; }
  </style>
</head>

<body>
  <div class="app">
    <h1>Expenses</h1>
    <p class="subtitle">Tap an item to edit. Use the bottom button to add a new one.</p>

    <div class="section-title">List</div>
    <div id="list"></div>

    <!-- Add form (inline, below list) -->
    <div id="createArea" style="display:none;"></div>
  </div>

  <!-- Frosted bottom bar -->
  <div class="bottom-glass">
    <div class="dock">
      <div class="dock-left-row">
        <div class="dock-btn ghost" onclick="goBack()" aria-label="Back" role="button" tabindex="0">←</div>
        <div class="dock-left">
          <p class="dock-title">Expenses</p>
          <p class="dock-sub" id="count">Loading…</p>
        </div>
      </div>

      <div class="dock-actions">
        <div class="dock-btn primary" onclick="toggleCreate()" aria-label="Add expense" role="button" tabindex="0">+</div>

        <div class="menu-wrap">
          <div class="dock-btn" id="menuBtn" aria-label="Menu" role="button" tabindex="0">⋯</div>
          <div class="menu-pop" id="menuPop">
            <a class="menu-item" href="/.auth/logout">Sign out</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // API calls
    // ---------------------------
    async function getBills() {
      const res = await fetch("/api/GetBills");
      if (!res.ok) throw new Error("Failed to load bills");
      const data = await res.json();
      // Supports either: [ ... ] OR { bills: [ ... ] }
      return Array.isArray(data) ? data : (data.bills || []);
    }

    async function setBills(payload) {
      const res = await fetch("/api/SetBills", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error("Failed to save bill");
    }

    // ---------------------------
    // State
    // ---------------------------
    let cachedBills = [];
    let createOpen = false;
    let editingId = null; // which existing item is being edited inline

    // ---------------------------
    // Helpers
    // ---------------------------
    function goBack() {
      window.location.href = "/index.html";
    }

    function setCountText(text) {
      document.getElementById("count").textContent = text;
    }

    function todayYMD() {
      const t = new Date();
      const y = t.getFullYear();
      const m = String(t.getMonth() + 1).padStart(2, "0");
      const d = String(t.getDate()).padStart(2, "0");
      return `${y}-${m}-${d}`;
    }

    function nextIdFrom(items) {
      const nums = items
        .map(x => Number(String(x?.id ?? "").trim()))
        .filter(n => Number.isFinite(n));
      if (!nums.length) return String(Date.now());
      return String(Math.max(...nums) + 1);
    }

    // Builds a form element (used for both Add and Update)
    function buildBillForm({ mode, bill, onSave, onCancel }) {
      const b = bill || {};
      const unit = b.frequency?.unit || "month";
      const interval = b.frequency?.interval || 1;

      const wrap = document.createElement("div");
      wrap.className = "form-card";
      wrap.onclick = (e) => e.stopPropagation(); // don’t toggle row when clicking inside form

      wrap.innerHTML = `
        <div class="form-grid">
          <div>
            <label>Name</label>
            <input name="name" placeholder="e.g., Admin - Firenze" />
          </div>

          <div>
            <label>Type</label>
            <select name="type">
              <option value="expense">expense</option>
              <option value="utility">utility</option>
              <option value="subscription">subscription</option>
              <option value="insurance">insurance</option>
              <option value="loan">loan</option>
              <option value="other">other</option>
            </select>
          </div>

          <div>
            <label>Start date</label>
            <input name="startDate" type="date" />
          </div>

          <div>
            <label>Frequency unit</label>
            <select name="unit">
              <option value="month">month</option>
              <option value="year">year</option>
            </select>
          </div>

          <div>
            <label>Frequency interval</label>
            <input name="interval" type="number" min="1" />
          </div>

          <div>
            <label>Reference (optional)</label>
            <input name="reference" placeholder="" />
          </div>

          <div class="checks">
            <label class="check">
              <input name="autoPay" type="checkbox" />
              <span>Auto pay</span>
            </label>

            <label class="check">
              <input name="isVariableAmount" type="checkbox" />
              <span>Variable amount</span>
            </label>

            <label class="check">
              <input name="isActive" type="checkbox" />
              <span>Active</span>
            </label>
          </div>

          <div class="row-actions">
            <button class="primaryBtn" type="button">${mode === "edit" ? "Update" : "Add"}</button>
            <button class="secondary" type="button">Cancel</button>
          </div>

          <div class="error"></div>
        </div>
      `;

      // Fill values
      const $ = (sel) => wrap.querySelector(sel);
      const nameEl = $('input[name="name"]');
      const typeEl = $('select[name="type"]');
      const startEl = $('input[name="startDate"]');
      const unitEl = $('select[name="unit"]');
      const intEl = $('input[name="interval"]');
      const refEl = $('input[name="reference"]');
      const autoEl = $('input[name="autoPay"]');
      const varEl = $('input[name="isVariableAmount"]');
      const activeEl = $('input[name="isActive"]');
      const primaryBtn = wrap.querySelector(".primaryBtn");
      const cancelBtn = wrap.querySelector("button.secondary");
      const errEl = wrap.querySelector(".error");

      nameEl.value = b.name || "";
      typeEl.value = b.type || "expense";
      startEl.value = b.startDate || todayYMD();
      unitEl.value = unit || "month";
      intEl.value = Number(interval) || 1;
      refEl.value = b.reference || "";
      autoEl.checked = !!b.autoPay;
      varEl.checked = !!b.isVariableAmount;
      activeEl.checked = (b.isActive !== undefined) ? !!b.isActive : true;

      function showErr(msg) {
        errEl.textContent = msg;
        errEl.style.display = "block";
      }
      function clearErr() {
        errEl.textContent = "";
        errEl.style.display = "none";
      }

      cancelBtn.onclick = () => onCancel?.();

      primaryBtn.onclick = async () => {
        clearErr();
        primaryBtn.disabled = true;
        cancelBtn.disabled = true;

        try {
          const payload = {
            id: String(b.id || ""), // may be replaced for add
            name: nameEl.value.trim(),
            type: typeEl.value,
            startDate: startEl.value,
            frequency: {
              unit: unitEl.value,
              interval: Number(intEl.value) || 1
            },
            reference: refEl.value || "",
            autoPay: !!autoEl.checked,
            isVariableAmount: !!varEl.checked,
            isActive: !!activeEl.checked
          };

          if (!payload.name) throw new Error("Name is required.");
          if (!payload.startDate) throw new Error("Start date is required.");
          if (!payload.frequency.unit) throw new Error("Frequency unit is required.");

          await onSave(payload);
        } catch (e) {
          showErr(e?.message || "Failed to save.");
        } finally {
          primaryBtn.disabled = false;
          cancelBtn.disabled = false;
        }
      };

      // focus first field
      setTimeout(() => nameEl.focus(), 0);

      return wrap;
    }

    // ---------------------------
    // Add form control
    // ---------------------------
    function toggleCreate(force) {
      createOpen = (typeof force === "boolean") ? force : !createOpen;

      // close any inline editor when opening add form (keeps UI calm)
      if (createOpen) editingId = null;

      const host = document.getElementById("createArea");
      host.innerHTML = "";
      host.style.display = createOpen ? "block" : "none";

      if (!createOpen) return;

      const form = buildBillForm({
        mode: "add",
        bill: {
          type: "expense",
          startDate: todayYMD(),
          frequency: { unit: "month", interval: 1 },
          autoPay: false,
          isVariableAmount: false,
          isActive: true,
          reference: ""
        },
        onSave: async (payload) => {
          // assign new id on add
          payload.id = nextIdFrom(cachedBills);
          await setBills(payload);
          toggleCreate(false);
          await load();
        },
        onCancel: () => toggleCreate(false)
      });

      host.appendChild(form);
    }

    // ---------------------------
    // Render list + inline edit
    // ---------------------------
    function renderList(items) {
      const list = document.getElementById("list");
      list.innerHTML = "";

      if (!items.length) {
        list.textContent = "Nothing here.";
        return;
      }

      for (const b of items) {
        const row = document.createElement("div");
        row.className = "row" + (editingId === b.id ? " editing" : "");
        row.onclick = () => {
          // close add form when editing an existing item
          if (createOpen) toggleCreate(false);

          editingId = (editingId === b.id) ? null : b.id;
          renderList(items);
        };

        const top = document.createElement("div");
        top.className = "row-top";

        const name = document.createElement("div");
        name.className = "name";
        name.textContent = b.name || "(no name)";

        const type = document.createElement("span");
        type.className = "type";
        type.textContent = String(b.type || "expense");

        top.append(name, type);

        const meta = document.createElement("div");
        meta.className = "meta";

        const unit = b.frequency?.unit || "month";
        const interval = b.frequency?.interval || 1;

        meta.innerHTML = `
          <span>Start: ${b.startDate || ""}</span>
          <span>Freq: ${interval} ${unit}${Number(interval) > 1 ? "s" : ""}</span>
          <span>Active: ${b.isActive ? "Yes" : "No"}</span>
          <span>AutoPay: ${b.autoPay ? "Yes" : "No"}</span>
        `;

        row.append(top, meta);
        list.appendChild(row);

        // Inline edit form under the selected row
        if (editingId === b.id) {
          const editor = buildBillForm({
            mode: "edit",
            bill: b,
            onSave: async (payload) => {
              // keep same id for update
              payload.id = String(b.id);
              await setBills(payload);
              editingId = null;
              await load();
            },
            onCancel: () => {
              editingId = null;
              renderList(items);
            }
          });

          list.appendChild(editor);
        }
      }
    }

    // ---------------------------
    // Load
    // ---------------------------
    async function load() {
      setCountText("Loading…");
      cachedBills = await getBills();

      const expensesOnly = cachedBills;
      
      renderList(expensesOnly);
      setCountText(`${expensesOnly.length} item${expensesOnly.length === 1 ? "" : "s"}`);
    }
    // Bottom-menu (⋯)
    (function setupMenu(){
      const btn = document.getElementById("menuBtn");
      const pop = document.getElementById("menuPop");
      if (!btn || !pop) return;

      function close() { pop.classList.remove("open"); }
      function toggle() { pop.classList.toggle("open"); }

      btn.onclick = (e) => { e.stopPropagation(); toggle(); };
      btn.onkeydown = (e) => {
        if (e.key === "Enter" || e.key === " ") { e.preventDefault(); toggle(); }
        if (e.key === "Escape") close();
      };

      document.addEventListener("click", (e) => {
        if (!pop.classList.contains("open")) return;
        if (pop.contains(e.target) || btn.contains(e.target)) return;
        close();
      });
      document.addEventListener("keydown", (e) => { if (e.key === "Escape") close(); });
    })();

    load().catch(() => {
      document.getElementById("list").textContent = "Failed to load expenses.";
      setCountText("Error");
    });
  </script>
</body>
</html>